var app={doing:!1,time:0,currentTimer:0,loop:!1,settings:{debug:!1,titleSep:" - ",pageTitle:"Cronometrei",homeTitleFull:"O tempo, sob controle",defaultBG:"london.jpg",startButton:"Iniciar",pauseButton:"Pausar",continueButton:"Continuar",clearButton:"Limpar",startInstruction:"Barra de Espaço",clearInstruction:"Esc",exitMessage:"Seu cronometro será perdido, deseja mesmo sair?",clearMessage:"Deseja mesmo zerar seu cronometro?",needToConfirm:!1,fbAppID:"387506448107274",apihost:"http://api.cronometrei.com.br/app"},user:{id:"",facebook_id:"",email:"",first_name:"",last_name:"",gender:"",link:"",locale:"",name:"",timezone:0,updated_time:"",verified:!1,options:{}},theme:{backgroundImage:"",appTitleColor:""},init:function(){return app.settings.debug&&console.log("Initializing app"),app.settings.debug&&console.log("Starting facebook integration"),window.fbAsyncInit=function(){FB.init({appId:app.settings.fbAppID,cookie:!0,xfbml:!0,version:"v2.2"}),FB.getLoginStatus(function(e){app.statusChangeCallback(e)})},window.onbeforeunload=app.confirmExit,!1},loadCronometer:function(){return app.createAppCanvas(),app.settings.needToConfirm=!1,app.time=0,app.currentTimer=0,app.sendToScreen(app.format_seconds(0)),app.setPageTitle(),app.loadTheme(),app.settings.debug&&console.log("Binding keyboard shortcuts"),$(document).keydown(function(e){app.keyDefaults(e)}).keyup(function(e){app.keyHandler(e)}),!1},checkLoginState:function(){FB.getLoginStatus(function(e){statusChangeCallback(e)})},statusChangeCallback:function(e){"connected"===e.status?(app.settings.debug&&console.log("User logged in! Fetching information.... "),FB.api("/me",function(e){app.loadUserInformation(e)})):(app.settings.debug&&console.log("User not logged, loading default app.... "),app.loadDefaultUser())},loadDefaultUser:function(){app.loadCronometer()},loadUserInformation:function(e){return $.ajax({url:app.settings.apihost+"/user/loadUserInfo",method:"POST",data:{json:JSON.stringify(e)},crossDomain:!0}).done(function(e){var t=JSON.parse(e);app.user.id=t.userid,app.user.facebook_id=t.id,app.user.email=t.email,app.user.first_name=t.first_name,app.user.last_name=t.last_name,app.user.gender=t.gender,app.user.link=t.link,app.user.locale=t.locale,app.user.name=t.name,app.user.timezone=t.timezone,app.user.updated_time=t.updated_time,app.user.verified=t.verified,app.loadCronometer()}).fail(function(){app.settings.debug&&console.log("Userinfo loagind failed, going on with default user info..."),app.loadDefaultUser()}),!0},createAppCanvas:function(){$("#application").append('<div id="titleRow" class="row"></div>'),$("#application").append('<div id="controlRow" class="row"></div>'),$("#titleRow").append('<h1 id="appTitle"></h1><div id="timer" class="col-md-8 col-md-offset-2"></div>'),$("#controlRow").append('<div id="startStop" class="button col-md-2 col-md-offset-3" onclick="app.startStopTimer();"><div id="startStopLabel"></div><div id="startStopInstruction" class="instructions"></div></div>'),$("#controlRow").append('<div id="clear" class="button col-md-2 col-md-offset-2" onclick="app.clearTimer();"><div id="clearLabel"></div><div id="clearInstruction" class="instructions"></div></div>')},setPageTitle:function(){document.title=app.settings.pageTitle+app.settings.titleSep+app.settings.homeTitleFull,$("h1#appTitle").html(app.settings.pageTitle),$("#startStopLabel").html(app.settings.startButton),$("#startStopInstruction").html(app.settings.startInstruction),$("#clearLabel").html(app.settings.clearButton),$("#clearInstruction").html(app.settings.clearInstruction)},keyDefaults:function(e){switch(e.keyCode){case 32:e.preventDefault();break;case 27:e.preventDefault();break;default:return!1}},keyHandler:function(e){switch(e.keyCode){case 32:app.startStopTimer();break;case 27:app.clearTimer();break;default:return!1}},confirmExit:function(){return app.settings.needToConfirm?app.settings.exitMessage:void 0},loadTheme:function(){app.settings.debug&&console.log("Loading theme");app.settings.debug&&console.log("Trying the API..."),$.ajax({url:"http://api.cronometrei.com.br/app/theme/loadTheme",method:"POST",data:{userid:app.user.id},crossDomain:!0}).done(function(e){var t=JSON.parse(e);app.settings.debug&&console.log("Loaded random background from api: "+t.image_name),app.theme.backgroundImage=t.image_name,app.theme.appTitleColor=t.logo_color}).fail(function(){app.settings.debug&&console.log("Ajax failed! Using default background: "+app.settings.defaultBG),app.theme.backgroundImage=app.settings.defaultBG}).always(function(){$("body").css("background-image",'url("assets/images/background/'+app.theme.backgroundImage+'")'),$("#appTitle").css("color",app.theme.appTitleColor)})},startStopTimer:function(){return app.settings.debug&&console.log("Call start/stop timer"),app.doing?app.pauseTimer():app.startTimer(app.currentTimer),!1},startTimer:function(){app.settings.debug&&console.log("Starting timer"),app.settings.needToConfirm=!0,app.doing=1,app.time="undefined"==typeof app.currentTimer?new Date:new Date-app.currentTimer,app.loop=window.setInterval("app.update()",10),$("#startStopLabel").html(app.settings.pauseButton)},stopTimer:function(){app.settings.debug&&console.log("Stopping timer"),app.doing=0,clearInterval(app.loop),$("#startStopLabel").html(app.settings.startButton)},pauseTimer:function(){app.settings.debug&&console.log("Pausing timer"),app.doing=0,clearInterval(app.loop),app.currentTimer=app.getTime(),$("#startStopLabel").html(app.settings.continueButton)},clearTimer:function(){app.settings.debug&&console.log("Clear timer"),bootbox.confirm(app.settings.clearMessage,function(e){e&&(app.stopTimer(),app.settings.needToConfirm=!1,app.time=0,app.currentTimer=0,app.sendToScreen(app.format_seconds(0)))})},update:function(){app.sendToScreen(app.format_seconds(app.getTime()))},sendToScreen:function(e){$("#timer").text(e)},getTime:function(){return new Date-app.time},format_seconds:function(e){isNaN(e)&&(e=0);var t=new Date(e),a=t.getUTCHours(),n=t.getMinutes(),e=t.getSeconds(),o=t.getMilliseconds();return 10>a&&(a="0"+a),10>n&&(n="0"+n),10>e&&(e="0"+e),10>o?o="00"+o:100>o&&(o="0"+o),document.title=a+":"+n+":"+e+app.settings.titleSep+app.settings.pageTitle,a+":"+n+":"+e+":"+o}};$(document).ready(function(){app.init()});