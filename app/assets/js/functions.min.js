/* ========================================================================
 * Cronometrei Webapp
 * http://www.cronometrei.com.br
 * Version: 2.0
 * ========================================================================
 * Copyright 2014-2015 R3 Web Solutions
 * ======================================================================== */

var app={doing:!1,time:0,currentTimer:0,loop:!1,progressValue:0,settings:{debug:!1,fbAppID:"387506448107274",apihost:"http://api.cronometrei.com.br/app",needToConfirm:!1,pageTitle:"Cronometrei",titleSep:" - ",homeTitleFull:"O tempo sob controle",defaultBG:"london.jpg",startButton:"Iniciar",pauseButton:"Pausar",continueButton:"Continuar",clearButton:"Limpar",startInstruction:"Barra de Espaço",clearInstruction:"Esc",exitMessage:"Seu cronometro será perdido, deseja mesmo sair?",clearMessage:"Deseja mesmo zerar seu cronometro?"},user:{logged:!1,id:"",facebook_id:"",email:"",first_name:"",last_name:"",gender:"",link:"",locale:"",name:"",timezone:0,updated_time:"",verified:!1,load:function(){},persist:function(){}},theme:{backgroundImage:"",appTitleColor:"#FFF",startStopButtonColor:"rgba(0,158,31,0.9)",clearButtonColor:"rgba(177,0,0,0.9)",setTheme:function(){$("body").css("background-image",'url("assets/images/background/'+this.backgroundImage+'")'),$("#appTitle").css("color",this.appTitleColor),$("#startStop").css("background",this.startStopButtonColor),$("#clear").css("background",this.clearButtonColor)}},init:function(){return this.checkDebugState(),this.outputMessage("Initializing app"),this.createAppElements(),this.createButtonLinks(),this.hookDocumentEvents(),this.resetTimer(),this.outputMessage("Starting facebook integration"),window.fbAsyncInit=function(){FB.init({appId:app.settings.fbAppID,cookie:!0,xfbml:!0,status:!0,version:"v2.2"}),app.checkLoginState()},!0},checkLoginState:function(){this.stepProgress(10),null!=this.readCookie("appUserId")&&""!=this.readCookie("appUserId")?(app.outputMessage("User logged into the app!"),app.stepProgress(10),app.user.logged=!0,app.user.id=this.readCookie("appUserId"),this.loadUserInformation()):(app.outputMessage("User NOT logged into the app! Trying facebook loggin instead"),FB.getLoginStatus(function(e){app.stepProgress(10),"connected"===e.status?(app.outputMessage("User logged into your app and Facebook! Fetching information.... "),app.loadFacebookInfo()):"not_authorized"===e.status?(app.outputMessage("User is logged into Facebook, but not your app. Loading default app.... "),app.user.logged=!1,app.stepProgress(10),app.loadCronometer()):(app.outputMessage("User is not logged into Facebook, so we're not sure if they are logged into this app or not. Loading default app.... "),app.user.logged=!1,app.stepProgress(10),app.loadCronometer())}))},checkDebugState:function(){var e=window.location.pathname,t=e.substring(e.lastIndexOf("/")+1);return"dev.php"===t&&(console.log("##########################################################\n##    Development mode detected. Going verbose mode.    ##\n########################################################## \n\n"),app.settings.debug=!0),!0},appLogin:function(e){return this.outputMessage("==> LOGGIN USER INTO THE APP"),app.user.logged=!0,app.createCookie("appUserId",e,30),!0},appLogout:function(){return this.outputMessage("==> LOGGIN USER OUT OF THE APP"),app.eraseCookie("appUserId"),!0},facebookLogin:function(){FB.login(function(){app.checkLoginState()},{scope:"public_profile,email"})},facebookLogout:function(){FB.logout(function(){app.checkLoginState()})},facebookRevoke:function(){FB.api("/me/permissions","delete",function(e){e.success&&(console.log("DESLOGADO!"),location.reload())})},loadFacebookInfo:function(){FB.api("/me",function(e){app.user.facebook_id=e.id,app.user.email=e.email,app.user.first_name=e.first_name,app.user.last_name=e.last_name,app.user.gender=e.gender,app.user.link=e.link,app.user.locale=e.locale,app.user.name=e.name,app.user.timezone=e.timezone,app.user.updated_time=e.updated_time,app.user.verified=e.verified,app.loadUserInformation()})},loadUserInformation:function(){return this.outputMessage("loading user info..."),$.ajax({url:app.settings.apihost+"/user/loadUserInfo",method:"POST",data:{json:JSON.stringify(app.user)},crossDomain:!0}).done(function(e){var t=JSON.parse(e);app.user.id=t.id,app.user.facebook_id=t.facebook_id,app.user.email=t.email,app.user.first_name=t.first_name,app.user.last_name=t.last_name,app.user.gender=t.gender,app.user.link=t.link,app.user.locale=t.locale,app.user.name=t.name,app.user.timezone=t.timezone,app.user.updated_time=t.updated_time,app.user.verified=t.verified,app.outputMessage("user info loaded"),app.user.logged||app.appLogin(t.id),app.loadCronometer()}).fail(function(){app.outputMessage("Userinfo loagind failed, going on with default user info..."),app.loadCronometer()}).always(function(){app.stepProgress(10)}),!0},loadCronometer:function(){return this.setPageTitle(),this.loadTheme(),this.loadCustomMenu(),!1},loadCustomMenu:function(){return this.stepProgress(10),app.user.logged?($("#btnTempos").removeClass("hide"),$("#btnAccount").removeClass("hide"),$("#btnLogin").addClass("hide")):($("#btnTempos").addClass("hide"),$("#btnAccount").addClass("hide"),$("#btnLogin").removeClass("hide")),!0},showLoginModal:function(){bootbox.dialog({title:"Faça seu login com o Facebook",message:'<div class="fb-login-button" data-max-rows="1" data-size="xlarge" data-show-faces="false" data-auto-logout-link="false"></div>'}),FB.XFBML.parse()},createAppElements:function(){this.stepProgress(10),$("#application").append('<div id="titleRow" class="row"></div>'),$("#application").append('<div id="controlRow" class="row"></div>'),$("#titleRow").append('<h1 id="appTitle"></h1><div id="timer" class="col-md-8 col-md-offset-2"></div>'),$("#controlRow").append('<div id="startStop" class="button col-md-2 col-md-offset-3" onclick="app.startStopTimer();"><div id="startStopLabel"></div><div id="startStopInstruction" class="instructions"></div></div>'),$("#controlRow").append('<div id="clear" class="button col-md-2 col-md-offset-2" onclick="app.clearTimer();"><div id="clearLabel"></div><div id="clearInstruction" class="instructions"></div></div>')},createButtonLinks:function(){this.stepProgress(10),$("#btnLogin > a").click(function(e){e.preventDefault(),app.facebookLogin()}),$("#btnLogout > a").click(function(e){e.preventDefault(),app.facebookLogout()})},setPageTitle:function(){this.stepProgress(10),document.title=app.settings.pageTitle+app.settings.titleSep+app.settings.homeTitleFull,$("h1#appTitle").html(app.settings.pageTitle),$("#startStopLabel").html(app.settings.startButton),$("#startStopInstruction").html(app.settings.startInstruction),$("#clearLabel").html(app.settings.clearButton),$("#clearInstruction").html(app.settings.clearInstruction)},keyDefaults:function(e){switch(e.keyCode){case 32:e.preventDefault();break;case 27:e.preventDefault();break;default:return!1}},keyHandler:function(e){switch(e.keyCode){case 32:app.startStopTimer();break;case 27:app.clearTimer();break;default:return!1}},confirmExit:function(){return app.settings.needToConfirm?app.settings.exitMessage:void 0},loadTheme:function(){this.stepProgress(10),this.outputMessage("Loading theme"),app.settings.debug&&console.log(""!=app.user.id?"theme for user: "+app.user.id:"theme generic"),$.ajax({url:app.settings.apihost+"/theme/loadTheme",method:"POST",data:{userid:app.user.id},crossDomain:!0}).done(function(e){var t=JSON.parse(e);app.outputMessage("Loaded random background from api: "+t.image_name),app.theme.backgroundImage=t.image_name,app.theme.appTitleColor=t.logo_color}).fail(function(){app.outputMessage("Ajax failed! Using default background: "+app.settings.defaultBG),app.theme.backgroundImage=app.settings.defaultBG}).always(function(){app.theme.setTheme(),app.stepProgress(10)})},stepProgress:function(e){this.progressValue+=e,app.loadingProgress(this.progressValue)},loadingProgress:function(e){100>e?$(".progress-bar").css("width",e+"%").attr("aria-valuenow",e).html(e+"%"):($(".progress-bar").css("width","100%").attr("aria-valuenow",100).html("100%"),$("#progressbar").addClass("opaque"),$("#application").removeClass("opaque"),$("header > nav").removeClass("opaque"),$("#appFooter").removeClass("opaque"))},outputMessage:function(e){app.settings.debug&&console.log(e)},startStopTimer:function(){return this.outputMessage("Call start/stop timer"),app.doing?app.pauseTimer():app.startTimer(app.currentTimer),!1},startTimer:function(){this.outputMessage("Starting timer"),app.settings.needToConfirm=!0,app.doing=1,app.time="undefined"==typeof app.currentTimer?new Date:new Date-app.currentTimer,app.loop=window.setInterval("app.update()",10),$("#startStopLabel").html(app.settings.pauseButton)},stopTimer:function(){this.outputMessage("Stopping timer"),app.doing=0,clearInterval(app.loop),$("#startStopLabel").html(app.settings.startButton)},pauseTimer:function(){this.outputMessage("Pausing timer"),app.doing=0,clearInterval(app.loop),app.currentTimer=app.getTime(),$("#startStopLabel").html(app.settings.continueButton)},clearTimer:function(){this.outputMessage("Clear timer"),bootbox.confirm(app.settings.clearMessage,function(e){e&&(app.stopTimer(),app.resetTimer())})},resetTimer:function(){app.settings.needToConfirm=!1,app.time=0,app.currentTimer=0,app.output(app.format_seconds(0))},update:function(){app.output(app.format_seconds(app.getTime()))},output:function(e){$("#timer").text(e)},getTime:function(){return new Date-app.time},format_seconds:function(e){isNaN(e)&&(e=0);var t=new Date(e),a=t.getUTCHours(),o=t.getMinutes(),e=t.getSeconds(),s=t.getMilliseconds();return 10>a&&(a="0"+a),10>o&&(o="0"+o),10>e&&(e="0"+e),10>s?s="00"+s:100>s&&(s="0"+s),document.title=a+":"+o+":"+e+app.settings.titleSep+app.settings.pageTitle,a+":"+o+":"+e+":"+s},hookDocumentEvents:function(){this.stepProgress(10),this.outputMessage("Binding keyboard shortcuts"),window.onbeforeunload=app.confirmExit,$(document).keydown(function(e){app.keyDefaults(e)}).keyup(function(e){app.keyHandler(e)})},createCookie:function(e,t,a){if(a){var o=new Date;o.setTime(o.getTime()+24*a*60*60*1e3);var s="; expires="+o.toGMTString()}else var s="";document.cookie=e+"="+t+s+"; path=/"},readCookie:function(e){for(var t=e+"=",a=document.cookie.split(";"),o=0;o<a.length;o++){for(var s=a[o];" "==s.charAt(0);)s=s.substring(1,s.length);if(0==s.indexOf(t))return s.substring(t.length,s.length)}return null},eraseCookie:function(e){this.createCookie(e,"",-1)}};$(document).ready(function(){app.init()});